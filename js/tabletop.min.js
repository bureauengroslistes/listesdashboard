(function(){var d=false;if(typeof process!=="undefined"&&!process.browser){d=true;var c=require("request".trim())}var i=false;var a=false;try{var b=new XMLHttpRequest();if(typeof b.withCredentials!=="undefined"){i=true}else{if("XDomainRequest" in window){i=true;a=true}}}catch(g){}var h=Array.prototype.indexOf;var j=function(n,m){var k=0,e=n.length;if(h&&n.indexOf===h){return n.indexOf(m)}for(;k<e;k++){if(n[k]===m){return k}}return -1};var f=function(e){if(!this||!(this instanceof f)){return new f(e)}if(typeof(e)==="string"){e={key:e}}this.callback=e.callback;this.wanted=e.wanted||[];this.key=e.key;this.simpleSheet=!!e.simpleSheet;this.parseNumbers=!!e.parseNumbers;this.wait=!!e.wait;this.reverse=!!e.reverse;this.postProcess=e.postProcess;this.debug=!!e.debug;this.query=e.query||"";this.orderby=e.orderby;this.endpoint=e.endpoint||"https://spreadsheets.google.com";this.singleton=!!e.singleton;this.simple_url=!!e.simple_url;this.callbackContext=e.callbackContext;this.prettyColumnNames=typeof(e.prettyColumnNames)=="undefined"?!e.proxy:e.prettyColumnNames;if(typeof(e.proxy)!=="undefined"){this.endpoint=e.proxy.replace(/\/$/,"");this.simple_url=true;this.singleton=true;i=false}this.parameterize=e.parameterize||false;if(this.singleton){if(typeof(f.singleton)!=="undefined"){this.log("WARNING! Tabletop singleton already defined")}f.singleton=this}if(/key=/.test(this.key)){this.log("You passed an old Google Docs url as the key! Attempting to parse.");this.key=this.key.match("key=(.*?)(&|#|$)")[1]}if(/pubhtml/.test(this.key)){this.log("You passed a new Google Spreadsheets url as the key! Attempting to parse.");this.key=this.key.match("d\\/(.*?)\\/pubhtml")[1]}if(!this.key){this.log("You need to pass Tabletop a key!");return}this.log("Initializing with key "+this.key);this.models={};this.model_names=[];this.base_json_path="/feeds/worksheets/"+this.key+"/public/basic?alt=";if(d||i){this.base_json_path+="json"}else{this.base_json_path+="json-in-script"}if(!this.wait){this.fetch()}};f.callbacks={};f.init=function(e){return new f(e)};f.sheets=function(){this.log("Times have changed! You'll want to use var tabletop = Tabletop.init(...); tabletop.sheets(...); instead of Tabletop.sheets(...)")};f.prototype={fetch:function(e){if(typeof(e)!=="undefined"){this.callback=e}this.requestData(this.base_json_path,this.loadSheets)},requestData:function(e,l){if(d){this.serverSideFetch(e,l)}else{var k=this.endpoint.split("//").shift()||"http";if(i&&(!a||k===location.protocol)){this.xhrFetch(e,l)}else{this.injectScript(e,l)}}},xhrFetch:function(k,m){var l=a?new XDomainRequest():new XMLHttpRequest();l.open("GET",this.endpoint+k);var e=this;l.onload=function(){try{var n=JSON.parse(l.responseText)}catch(o){console.error(o)}m.call(e,n)};l.send()},injectScript:function(n,o){var k=document.createElement("script");var m;if(this.singleton){if(o===this.loadSheets){m="Tabletop.singleton.loadSheets"}else{if(o===this.loadSheet){m="Tabletop.singleton.loadSheet"}}}else{var e=this;m="tt"+(+new Date())+(Math.floor(Math.random()*100000));f.callbacks[m]=function(){var p=Array.prototype.slice.call(arguments,0);o.apply(e,p);k.parentNode.removeChild(k);delete f.callbacks[m]};m="Tabletop.callbacks."+m}var l=n+"&callback="+m;if(this.simple_url){if(n.indexOf("/list/")!==-1){k.src=this.endpoint+"/"+this.key+"-"+n.split("/")[4]}else{k.src=this.endpoint+"/"+this.key}}else{k.src=this.endpoint+l}if(this.parameterize){k.src=this.parameterize+encodeURIComponent(k.src)}document.getElementsByTagName("script")[0].parentNode.appendChild(k)},serverSideFetch:function(k,l){var e=this;c({url:this.endpoint+k,json:true},function(n,o,m){if(n){return console.error(n)}l.call(e,m)})},isWanted:function(e){if(this.wanted.length===0){return true}else{return(j(this.wanted,e)!==-1)}},data:function(){if(this.model_names.length===0){return undefined}if(this.simpleSheet){if(this.model_names.length>1&&this.debug){this.log("WARNING You have more than one sheet but are using simple sheet mode! Don't blame me when something goes wrong.")}return this.models[this.model_names[0]].all()}else{return this.models}},addWanted:function(e){if(j(this.wanted,e)===-1){this.wanted.push(e)}},loadSheets:function(n){var k,e;var m=[];this.googleSheetName=n.feed.title.$t;this.foundSheetNames=[];for(k=0,e=n.feed.entry.length;k<e;k++){this.foundSheetNames.push(n.feed.entry[k].title.$t);if(this.isWanted(n.feed.entry[k].content.$t)){var p=n.feed.entry[k].link.length-1;var l=n.feed.entry[k].link[p].href.split("/").pop();var o="/feeds/list/"+this.key+"/"+l+"/public/values?alt=";if(d||i){o+="json"}else{o+="json-in-script"}if(this.query){o+="&sq="+this.query}if(this.orderby){o+="&orderby=column:"+this.orderby.toLowerCase()}if(this.reverse){o+="&reverse=true"}m.push(o)}}this.sheetsToLoad=m.length;for(k=0,e=m.length;k<e;k++){this.requestData(m[k],this.loadSheet)}},sheets:function(e){if(typeof e==="undefined"){return this.models}else{if(typeof(this.models[e])==="undefined"){return}else{return this.models[e]}}},sheetReady:function(e){this.models[e.name]=e;if(j(this.model_names,e.name)===-1){this.model_names.push(e.name)}this.sheetsToLoad--;if(this.sheetsToLoad===0){this.doCallback()}},loadSheet:function(l){var k=this;var e=new f.Model({data:l,parseNumbers:this.parseNumbers,postProcess:this.postProcess,tabletop:this,prettyColumnNames:this.prettyColumnNames,onReady:function(){k.sheetReady(this)}})},doCallback:function(){if(this.sheetsToLoad===0){this.callback.apply(this.callbackContext||this,[this.data(),this])}},log:function(e){if(this.debug){if(typeof console!=="undefined"&&typeof console.log!=="undefined"){Function.prototype.apply.apply(console.log,[console,arguments])}}}};f.Model=function(r){var m,l,k,q;this.column_names=[];this.name=r.data.feed.title.$t;this.tabletop=r.tabletop;this.elements=[];this.onReady=r.onReady;this.raw=r.data;if(typeof(r.data.feed.entry)==="undefined"){r.tabletop.log("Missing data for "+this.name+", make sure you didn't forget column headers");this.original_columns=[];this.elements=[];this.onReady.call(this);return}for(var p in r.data.feed.entry[0]){if(/^gsx/.test(p)){this.column_names.push(p.replace("gsx$",""))}}this.original_columns=this.column_names;for(m=0,k=r.data.feed.entry.length;m<k;m++){var e=r.data.feed.entry[m];var n={};for(var l=0,q=this.column_names.length;l<q;l++){var o=e["gsx$"+this.column_names[l]];if(typeof(o)!=="undefined"){if(r.parseNumbers&&o.$t!==""&&!isNaN(o.$t)){n[this.column_names[l]]=+o.$t}else{n[this.column_names[l]]=o.$t}}else{n[this.column_names[l]]=""}}if(n.rowNumber===undefined){n.rowNumber=m+1}if(r.postProcess){r.postProcess(n)}this.elements.push(n)}if(r.prettyColumnNames){this.fetchPrettyColumns()}else{this.onReady.call(this)}};f.Model.prototype={all:function(){return this.elements},fetchPrettyColumns:function(){if(!this.raw.feed.link[3]){return this.ready()}var e=this.raw.feed.link[3].href.replace("/feeds/list/","/feeds/cells/").replace("https://spreadsheets.google.com","");var k=this;this.tabletop.requestData(e,function(l){k.loadPrettyColumns(l)})},ready:function(){this.onReady.call(this)},loadPrettyColumns:function(o){var m={};var k=this.column_names;var n=0;var e=k.length;for(;n<e;n++){if(typeof o.feed.entry[n].content.$t!=="undefined"){m[k[n]]=o.feed.entry[n].content.$t}else{m[k[n]]=k[n]}}this.pretty_columns=m;this.prettifyElements();this.ready()},prettifyElements:function(){var p=[],o=[],n,k,m,e;var o;for(k=0,e=this.column_names.length;k<e;k++){o.push(this.pretty_columns[this.column_names[k]])}for(n=0,m=this.elements.length;n<m;n++){var l={};for(k=0,e=this.column_names.length;k<e;k++){var q=this.pretty_columns[this.column_names[k]];l[q]=this.elements[n][this.column_names[k]]}p.push(l)}this.elements=p;this.column_names=o},toArray:function(){var o=[],m,k,l,e;for(m=0,l=this.elements.length;m<l;m++){var n=[];for(k=0,e=this.column_names.length;k<e;k++){n.push(this.elements[m][this.column_names[k]])}o.push(n)}return o}};if(typeof module!=="undefined"&&module.exports){module.exports=f}else{if(typeof define==="function"&&define.amd){define(function(){return f})}else{window.Tabletop=f}}})();